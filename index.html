<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trading Matrix</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Theming --- */
        :root {
            --bg-light-start: #667eea;
            --bg-light-end: #764ba2;
            --bg-dark-start: #1a1d29;
            --bg-dark-end: #2d1b69;
            --text-light: #e2e8f0;
            --text-dark: #333;
            --card-light: rgba(255, 255, 255, 0.95);
            --card-dark: rgba(37, 40, 54, 0.9);
            --primary-light: #667eea;
            --primary-dark: #7c3aed;
            --accent-green: #00ff00;
            --accent-red: #ff3b3b;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-light-start) 0%, var(--bg-light-end) 100%);
            color: var(--text-dark);
            transition: all 0.4s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--bg-dark-start) 0%, var(--bg-dark-end) 100%);
            color: var(--text-light);
        }
        
        #matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-family: var(--font-main);
            font-weight: 900;
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }

        .header h1 .matrix-text {
            color: var(--accent-green);
            text-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .dashboard-metric {
            text-align: center;
            color: white;
        }

        .dashboard-metric .label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .dashboard-metric .value {
            font-family: var(--font-mono);
            font-size: 1.8em;
            font-weight: 700;
            transition: color 0.3s ease;
        }
        
        .value.positive {
            color: var(--accent-green);
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
        }
        .value.negative {
            color: var(--accent-red);
            text-shadow: 0 0 8px rgba(255, 59, 59, 0.5);
        }


        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* --- Components --- */
        .card {
            background: var(--card-light);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, background 0.4s ease;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            flex: 1 1 calc(50% - 12.5px);
            min-width: 0;
        }
        
        .dark-mode .card {
            background: var(--card-dark);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.05);
        }

        @media (hover: hover) {
            .card:hover {
                transform: translateY(-5px);
            }
        }

        .card h2 {
            color: var(--primary-light);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }
        
        .dark-mode .card h2 {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-dark);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .dark-mode .form-group label {
            color: #d1d5db;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: var(--font-mono);
            transition: border-color 0.3s ease, background 0.4s ease;
            background: #f9f9f9;
        }
        
        .dark-mode .form-group input, .dark-mode .form-group select {
            background: #1f2937;
            border-color: #374151;
            color: var(--text-light);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-light);
        }
        
        .dark-mode .form-group input:focus, .dark-mode .form-group select:focus {
            border-color: var(--primary-dark);
        }

        .toggle-group {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .dark-mode .toggle-group {
            background: #374151;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #555;
        }
        
        .dark-mode .toggle-btn {
            color: #d1d5db;
        }

        .toggle-btn.active {
            background: var(--primary-light);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
        }
        
        .dark-mode .toggle-btn.active {
            background: var(--primary-dark);
            box-shadow: 0 2px 10px rgba(124, 58, 237, 0.4);
        }

        .btn {
            background: linear-gradient(45deg, var(--primary-light), var(--bg-light-end));
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
        }
        
        .dark-mode .btn {
             background: linear-gradient(45deg, var(--primary-dark), var(--bg-dark-end));
        }

        @media (hover: hover) {
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }
            .dark-mode .btn:hover {
                box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
            }
        }

        .btn.tertiary {
            background: #6c757d;
        }
        
        .dark-mode .btn.tertiary {
            background: #4b5563;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .alert.success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert.warning { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .alert.danger { background: #f8d7da; color: #721c24; border-color: #f1aeb5; }
        .alert.info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }

        .dark-mode .alert.success { background: #064e3b; color: #6ee7b7; border-color: #10b981; }
        .dark-mode .alert.warning { background: #78350f; color: #fcd34d; border-color: #f59e0b; }
        .dark-mode .alert.danger { background: #7f1d1d; color: #fca5a5; border-color: #ef4444; }
        .dark-mode .alert.info { background: #1e40af; color: #93c5fd; border-color: #3b82f6; }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        @media (hover: hover) {
            .theme-toggle:hover {
                background: rgba(255,255,255,0.3);
                transform: scale(1.1) rotate(15deg);
            }
        }
        
        .dark-mode .theme-toggle {
            background: rgba(0,0,0,0.3);
        }
        
        /* --- R:R Section Specifics --- */
        .rr-card {
            flex: 1 1 100%;
        }
        
        .rr-targets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .rr-level {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .dark-mode .rr-level {
            background: #1f2937;
            border-color: #374151;
        }
        
        .rr-level.achieved {
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .rr-level.banking {
            border-color: #ffc107;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
        }
        
        .rr-level .title { font-weight: bold; color: var(--primary-light); }
        .dark-mode .rr-level .title { color: var(--primary-dark); }
        .rr-level .price { font-size: 1.5em; font-weight: bold; font-family: var(--font-mono); margin: 5px 0; }
        .rr-level .profit { font-size: 0.9em; color: #666; font-family: var(--font-mono); }
        .dark-mode .rr-level .profit { color: #9ca3af; }
        
        .rr-meter {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        .dark-mode .rr-meter { background: #374151; }
        
        .rr-meter-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-green);
            border-radius: 5px;
            transition: width 0.5s ease-out;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .card { padding: 15px; }
            .header h1 { font-size: 2em; }
            .dashboard {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                padding: 10px;
                margin-top: 20px;
                margin-bottom: 0;
                background: rgba(0,0,0,0.05);
                border-radius: 10px;
            }
            .dark-mode .dashboard {
                background: rgba(255,255,255,0.05);
            }
            .dashboard-metric .value { font-size: 1.2em; }
            .dashboard-metric .label { font-size: 0.7em; }
            
            .main-content {
                gap: 15px;
            }
        }
        
        @media (max-width: 600px) {
             .main-content > .card:not(.rr-card) {
                flex-basis: 100%;
             }
             #desktop-dashboard {
                display: none;
             }
             .in-card-dashboard {
                display: grid;
             }
        }

        .in-card-dashboard {
            display: none;
        }
        
        .in-card-dashboard .dashboard-metric {
            color: var(--text-dark);
        }
        .dark-mode .in-card-dashboard .dashboard-metric {
            color: var(--text-light);
        }
        .in-card-dashboard .dashboard-metric .label {
            opacity: 0.7;
        }
        
        .mobile-dash-separator {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0));
            margin: 20px 0;
        }
        .dark-mode .mobile-dash-separator {
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
        }


    </style>
</head>
<body class="dark-mode">
    <canvas id="matrix-bg"></canvas>
    <button class="theme-toggle" id="themeToggle">üåì</button>
    
    <div class="container">
        <header class="header">
            <h1>The <span class="matrix-text">Trading Matrix</span></h1>
            <p>Never Let Green Turn Red</p>
        </header>

        <section class="dashboard" id="desktop-dashboard">
            <div class="dashboard-metric">
                <div class="label">Profit %</div>
                <div class="value" id="dashProfitPercent">0.0%</div>
            </div>
            <div class="dashboard-metric">
                <div class="label">Stop Loss</div>
                <div class="value" id="dashStopLoss">$0.00</div>
            </div>
            <div class="dashboard-metric">
                <div class="label" id="dashStopLabel">Risk %</div>
                <div class="value" id="dashStopPercent">0.0%</div>
            </div>
        </section>

        <main class="main-content">
            <div class="card">
                <h2>Trade Setup</h2>
                <div class="form-group">
                    <label>Trade Type</label>
                    <div class="toggle-group" id="tradeTypeToggle">
                        <button class="toggle-btn" data-type="day">Day Trade</button>
                        <button class="toggle-btn active" data-type="swing">Swing Trade</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Risk Profile</label>
                    <div class="toggle-group" id="riskProfileToggle">
                        <button class="toggle-btn" data-profile="conservative">Conservative</button>
                        <button class="toggle-btn active" data-profile="balanced">Balanced</button>
                        <button class="toggle-btn" data-profile="aggressive">Aggressive</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="contracts">Number of Contracts</label>
                    <select id="contracts">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="10">10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="avgPrice">Entry Price ($)</label>
                    <input type="number" id="avgPrice" step="0.01" min="0.01" placeholder="2.50" inputmode="decimal">
                </div>
            </div>

            <div class="card">
                <h2>Stop Loss Management</h2>
                <div class="form-group">
                    <label for="currentPrice">Current Price ($)</label>
                    <input type="number" id="currentPrice" step="0.01" min="0.01" placeholder="e.g., 2.75" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="delta">Option Delta</label>
                    <input type="number" id="delta" step="0.01" min="0.01" max="1.00" placeholder="0.35" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="atrValue">Stock ATR (<span id="atrTimeframe">1hr</span>)</label>
                    <input type="number" id="atrValue" step="0.01" min="0.01" placeholder="1.25" inputmode="decimal">
                </div>

                <hr class="mobile-dash-separator">

                <section class="dashboard in-card-dashboard" id="mobile-dashboard">
                     <div class="dashboard-metric">
                        <div class="label">Profit %</div>
                        <div class="value" id="mobileDashProfitPercent">0.0%</div>
                    </div>
                    <div class="dashboard-metric">
                        <div class="label">Stop Loss</div>
                        <div class="value" id="mobileDashStopLoss">$0.00</div>
                    </div>
                    <div class="dashboard-metric">
                        <div class="label" id="mobileDashStopLabel">Risk %</div>
                        <div class="value" id="mobileDashStopPercent">0.0%</div>
                    </div>
                </section>
            </div>

            <div class="card rr-card">
                <h2>R:R Take Profit Targets</h2>
                <div class="rr-targets" id="rrTargetsContainer">
                    <!-- R:R levels will be injected here by JS -->
                </div>
                <div class="form-group" id="rrMeterContainer" style="display: none;">
                    <label>Progress to 5R</label>
                    <div class="rr-meter">
                        <div class="rr-meter-fill" id="rrMeterFill"></div>
                    </div>
                </div>
                <p id="rrGuidance" style="text-align: center; opacity: 0.8;"></p>
            </div>
        </main>
        
        <div id="alertMessage" style="min-height: 60px;"></div>

        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button type="button" class="btn" id="calculateBtn">Force Recalculate</button>
            <button type="button" class="btn tertiary" id="clearBtn">Clear All</button>
        </div>
        
        <footer class="footer">
            üíä Precision Risk Management | Never Let Profits Turn Into Losses
        </footer>
    </div>

    <script>
        // --- Animated Background ---
        const canvas = document.getElementById('matrix-bg');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%';
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
            ctx.font = fontSize + 'px arial';

            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 33);
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // --- Core Application Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Caching ---
            const themeToggle = document.getElementById('themeToggle');
            const tradeTypeToggle = document.getElementById('tradeTypeToggle');
            const riskProfileToggle = document.getElementById('riskProfileToggle');
            const contractsEl = document.getElementById('contracts');
            const avgPriceEl = document.getElementById('avgPrice');
            const currentPriceEl = document.getElementById('currentPrice');
            const deltaEl = document.getElementById('delta');
            const atrValueEl = document.getElementById('atrValue');
            const atrTimeframeEl = document.getElementById('atrTimeframe');
            const calculateBtn = document.getElementById('calculateBtn');
            const clearBtn = document.getElementById('clearBtn');
            const alertMessageEl = document.getElementById('alertMessage');
            const rrTargetsContainer = document.getElementById('rrTargetsContainer');
            const rrMeterContainer = document.getElementById('rrMeterContainer');
            const rrMeterFill = document.getElementById('rrMeterFill');
            const rrGuidance = document.getElementById('rrGuidance');
            
            // Desktop Dashboard
            const desktopDashboard = document.getElementById('desktop-dashboard');
            const dashProfitPercent = document.getElementById('dashProfitPercent');
            const dashStopLoss = document.getElementById('dashStopLoss');
            const dashStopPercent = document.getElementById('dashStopPercent');
            const dashStopLabel = document.getElementById('dashStopLabel');

            // Mobile Dashboard
            const mobileDashboard = document.getElementById('mobile-dashboard');
            const mobileDashProfitPercent = document.getElementById('mobileDashProfitPercent');
            const mobileDashStopLoss = document.getElementById('mobileDashStopLoss');
            const mobileDashStopPercent = document.getElementById('mobileDashStopPercent');
            const mobileDashStopLabel = document.getElementById('mobileDashStopLabel');


            // --- State Management ---
            let state = {
                tradeType: 'swing',
                riskProfile: 'balanced',
                storedStopLoss: null,
                achievedRLevels: { r1: false, r2: false, r3: false, r5: false }
            };

            const TRADE_STATE_KEY = 'tradingMatrixState';

            // --- Event Listeners ---
            themeToggle.addEventListener('click', toggleTheme);
            
            calculateBtn.addEventListener('click', () => {
                state.storedStopLoss = null;
                runCalculations();
                saveState();
            });

            clearBtn.addEventListener('click', clearAll);
            
            tradeTypeToggle.addEventListener('click', (e) => handleToggle(e, 'tradeType', setAtrTimeframe));
            riskProfileToggle.addEventListener('click', (e) => handleToggle(e, 'riskProfile'));
            
            avgPriceEl.addEventListener('input', () => {
                if (!currentPriceEl.value) {
                    currentPriceEl.value = avgPriceEl.value;
                }
                runCalculations();
                saveState();
            });

            [currentPriceEl, deltaEl, atrValueEl, contractsEl].forEach(el => {
                el.addEventListener('input', () => {
                    runCalculations();
                    saveState();
                });
            });

            // --- Functions ---
            function toggleTheme() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('tradingMatrixTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            }

            function handleToggle(e, stateKey, callback) {
                if (e.target.classList.contains('toggle-btn')) {
                    const parent = e.target.parentElement;
                    if (parent.querySelector('.active')) {
                        parent.querySelector('.active').classList.remove('active');
                    }
                    e.target.classList.add('active');
                    state[stateKey] = e.target.dataset[stateKey === 'tradeType' ? 'type' : 'profile'];
                    if (callback) callback();
                    runCalculations();
                    saveState();
                }
            }
            
            function setAtrTimeframe() {
                if (atrTimeframeEl) {
                    atrTimeframeEl.textContent = state.tradeType === 'day' ? '15m' : '1hr';
                }
            }

            function animateNumber(element, start, end, duration, isPrice = false, suffix = '') {
                if (!element) return;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = progress * (end - start) + start;
                    if (isPrice) {
                        element.textContent = '$' + value.toFixed(2);
                    } else {
                        element.textContent = value.toFixed(1) + suffix;
                    }
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

            function runCalculations() {
                const inputs = getAndValidateInputs();
                if (!inputs) {
                    updateDashboard(null);
                    updateRRDisplay(null);
                    return;
                }

                const stopLossResult = calculateStopLoss(inputs);
                updateDashboard(stopLossResult);
                
                const rrTargets = calculateRRTargets(inputs, stopLossResult);
                updateRRDisplay(rrTargets, inputs.currentPrice);
                
                displayAlert(stopLossResult, inputs);
            }

            function getAndValidateInputs() {
                const avgPrice = parseFloat(avgPriceEl.value);
                const currentPrice = parseFloat(currentPriceEl.value);
                const delta = parseFloat(deltaEl.value);
                const stockATR = parseFloat(atrValueEl.value);
                const contracts = parseInt(contractsEl.value);

                let missingFields = [];
                if (isNaN(avgPrice) || avgPrice <= 0) missingFields.push("Entry Price");
                if (isNaN(currentPrice) || currentPrice <= 0) missingFields.push("Current Price");
                if (isNaN(delta) || delta <= 0) missingFields.push("Delta");
                if (isNaN(stockATR) || stockATR <= 0) missingFields.push("Stock ATR");

                if (missingFields.length > 0) {
                    alertMessageEl.innerHTML = `<div class="alert warning">‚ö†Ô∏è Missing or invalid: ${missingFields.join(", ")}</div>`;
                    return null;
                }
                
                if (delta > 1.0) {
                     alertMessageEl.innerHTML = `<div class="alert danger">üö® Delta cannot exceed 1.0</div>`;
                     return null;
                }
                
                if (currentPrice > avgPrice * 6) {
                    alertMessageEl.innerHTML = `<div class="alert warning">‚ö†Ô∏è Extreme profit detected. Please verify inputs are correct.</div>`;
                } else {
                    alertMessageEl.innerHTML = '';
                }

                return { avgPrice, currentPrice, delta, stockATR, contracts };
            }

            function getAtrMultipliers() {
                const profiles = {
                    conservative: [0.8, 0.6, 0.4, 0.3, 0.2],
                    balanced: [1.0, 0.8, 0.6, 0.4, 0.25],
                    aggressive: [1.3, 1.0, 0.7, 0.5, 0.3]
                };
                return profiles[state.riskProfile] || profiles.balanced;
            }

            function calculateStopLoss(inputs) {
                const { avgPrice, currentPrice, delta, stockATR } = inputs;
                const optionATR = stockATR * delta;
                const profitPerContract = currentPrice - avgPrice;
                const profitPercent = avgPrice > 0 ? (profitPerContract / avgPrice) * 100 : 0;

                if (profitPerContract <= 0) {
                    state.storedStopLoss = null;
                    let maxRiskPercent;
                    switch(state.riskProfile) {
                        case 'conservative': maxRiskPercent = 0.88; break;
                        case 'aggressive': maxRiskPercent = 0.82; break;
                        default: maxRiskPercent = 0.85;
                    }
                    const atrStop = currentPrice - (optionATR * 1.3);
                    const maxRiskStop = avgPrice * maxRiskPercent;
                    const stopLoss = Math.max(atrStop, maxRiskStop);
                    return { stopLoss, profitPercent, isLosing: true, avgPrice };
                }

                const lockFactor = Math.min(0.95, 1 - Math.exp(-profitPercent / 80));
                const profitLock = avgPrice + (profitPerContract * lockFactor);

                const multipliers = getAtrMultipliers();
                const baseMultiplier = state.tradeType === 'swing' ? 1.2 : 1.0;
                let atrMultiplier;
                if (profitPercent < 25) atrMultiplier = multipliers[0] * baseMultiplier;
                else if (profitPercent < 50) atrMultiplier = multipliers[1] * baseMultiplier;
                else if (profitPercent < 100) atrMultiplier = multipliers[2] * baseMultiplier;
                else if (profitPercent < 200) atrMultiplier = multipliers[3] * baseMultiplier;
                else atrMultiplier = multipliers[4] * baseMultiplier;
                const atrTrail = currentPrice - (optionATR * atrMultiplier);
                
                const maxGiveback = currentPrice - (profitPerContract * 0.25);

                let stopLoss = Math.max(profitLock, atrTrail, maxGiveback);

                let bufferPercent;
                if (profitPercent < 30) bufferPercent = 0.06;
                else if (profitPercent < 75) bufferPercent = 0.04;
                else bufferPercent = 0.03;
                
                const minBuffer = currentPrice * bufferPercent;
                const bufferStop = currentPrice - minBuffer;
                stopLoss = Math.min(stopLoss, bufferStop);

                if (profitPercent >= 30) {
                    const breakevenFloor = avgPrice * 1.02;
                    stopLoss = Math.max(stopLoss, breakevenFloor);
                }

                if (state.storedStopLoss && stopLoss < state.storedStopLoss) {
                    stopLoss = state.storedStopLoss;
                } else {
                    state.storedStopLoss = stopLoss;
                }
                
                return { stopLoss, profitPercent, isLosing: false, avgPrice };
            }
            
            function calculateRRTargets(inputs, stopLossResult) {
                if (!inputs || !stopLossResult) return null;
                const { avgPrice } = inputs;
                
                let maxRiskPercent;
                switch(state.riskProfile) {
                    case 'conservative': maxRiskPercent = 0.88; break;
                    case 'aggressive': maxRiskPercent = 0.82; break;
                    default: maxRiskPercent = 0.85;
                }
                const initialAtrStop = avgPrice - (inputs.stockATR * inputs.delta * 1.3);
                const initialMaxRiskStop = avgPrice * maxRiskPercent;
                const initialStop = Math.max(initialAtrStop, initialMaxRiskStop);
                
                const riskAmount = avgPrice - initialStop;
                if (riskAmount <= 0) return null;
                
                return {
                    r1: { price: avgPrice + riskAmount, profit: riskAmount * 100 },
                    r2: { price: avgPrice + riskAmount * 2, profit: riskAmount * 2 * 100 },
                    r3: { price: avgPrice + riskAmount * 3, profit: riskAmount * 3 * 100 },
                    r5: { price: avgPrice + riskAmount * 5, profit: riskAmount * 5 * 100 },
                    riskAmount
                };
            }

            function updateDashboard(result) {
                const dashboards = [
                    { profit: dashProfitPercent, stop: dashStopLoss, percent: dashStopPercent, label: dashStopLabel },
                    { profit: mobileDashProfitPercent, stop: mobileDashStopLoss, percent: mobileDashStopPercent, label: mobileDashStopLabel }
                ];

                dashboards.forEach(d => {
                    if (!result) {
                        d.profit.textContent = '0.0%';
                        d.stop.textContent = '$0.00';
                        d.percent.textContent = '0.0%';
                        d.label.textContent = 'Risk %';
                        d.profit.classList.remove('positive', 'negative');
                        return;
                    }
                    const { stopLoss, profitPercent, avgPrice, isLosing } = result;
                    
                    animateNumber(d.profit, parseFloat(d.profit.textContent) || 0, profitPercent, 300, false, '%');
                    animateNumber(d.stop, parseFloat(d.stop.textContent.replace('$', '')) || 0, stopLoss, 300, true);
                    
                    if (profitPercent > 0) {
                        d.profit.classList.add('positive');
                        d.profit.classList.remove('negative');
                    } else if (profitPercent < 0) {
                        d.profit.classList.add('negative');
                        d.profit.classList.remove('positive');
                    } else {
                        d.profit.classList.remove('positive', 'negative');
                    }

                    const stopPercent = avgPrice > 0 ? ((stopLoss - avgPrice) / avgPrice) * 100 : 0;
                    
                    if (isLosing || stopLoss < avgPrice) {
                        d.label.textContent = 'Risk %';
                        animateNumber(d.percent, parseFloat(d.percent.textContent) || 0, Math.abs(stopPercent), 300, false, '%');
                    } else {
                        d.label.textContent = 'Locked Profit %';
                        animateNumber(d.percent, parseFloat(d.percent.textContent) || 0, stopPercent, 300, false, '%');
                    }
                });
            }
            
            function updateRRDisplay(rrTargets, currentPrice) {
                if (!rrTargets) {
                    rrTargetsContainer.innerHTML = '<p style="text-align:center; opacity:0.7;">Enter trade details to see R:R targets.</p>';
                    rrMeterContainer.style.display = 'none';
                    rrGuidance.textContent = '';
                    return;
                }
                
                const { r1, r2, r3, r5, riskAmount } = rrTargets;
                const levels = { r1, r2, r3, r5 };
                
                let html = '';
                Object.entries(levels).forEach(([key, value]) => {
                    const isAchieved = currentPrice >= value.price;
                    if (isAchieved && !state.achievedRLevels[key]) {
                        state.achievedRLevels[key] = true;
                    }
                    const achievedClass = isAchieved ? 'achieved' : '';
                    const bankingClass = key === 'r2' ? 'banking' : '';
                    
                    html += `
                        <div class="rr-level ${achievedClass} ${bankingClass}">
                            <div class="title">${key.toUpperCase()} ${key === 'r2' ? 'üéØ' : ''}</div>
                            <div class="price">$${value.price.toFixed(2)}</div>
                            <div class="profit">+$${value.profit.toFixed(0)}/contract</div>
                        </div>
                    `;
                });
                rrTargetsContainer.innerHTML = html;
                
                const progress = Math.min(((currentPrice - (r1.price - riskAmount)) / (r5.price - (r1.price - riskAmount))) * 100, 100);
                rrMeterFill.style.width = `${Math.max(0, progress)}%`;
                rrMeterContainer.style.display = 'block';
                
                const contracts = parseInt(contractsEl.value);
                let guidanceText = '';

                if (state.tradeType === 'day') {
                     switch (contracts) {
                        case 1: guidanceText = 'üí° Day Trade: Target 2R for a clean, disciplined exit.'; break;
                        case 2: guidanceText = 'üí° Day Trade: Consider selling 1 at 1R and the second at 2R.'; break;
                        default: guidanceText = 'üí° Day Trade: Systematically take profits at 1R and 2R levels.';
                    }
                } else { // Swing Trade
                    switch (contracts) {
                        case 1: guidanceText = 'üí° Swing: Hold until stop or exit at a key R-level (e.g., 3R).'; break;
                        case 2: guidanceText = 'üí° Swing: Consider selling 1 at 2R, trail the rest for a home run.'; break;
                        default: guidanceText = 'üí° Swing: Systematically scale out at R-levels to lock in profits.';
                    }
                }
                rrGuidance.textContent = guidanceText;
            }

            function displayAlert(result, inputs) {
                if (!result || !inputs || alertMessageEl.querySelector('.warning')) return;
                
                const { stopLoss, profitPercent, isLosing, avgPrice } = result;
                let message = '';
                let alertClass = '';

                if (isLosing) {
                    const riskAmount = Math.abs(stopLoss - avgPrice) * 100;
                    message = `üî¥ Position is currently down. Set initial stop loss at <strong>$${stopLoss.toFixed(2)}</strong> to manage risk (Risk: $${riskAmount.toFixed(0)}/contract).`;
                    alertClass = 'danger';
                } else {
                    const lockedProfit = Math.max(0, stopLoss - avgPrice) * 100;
                    message = `‚úÖ Position is profitable. Set trailing stop at <strong>$${stopLoss.toFixed(2)}</strong>. (Locked Profit: $${lockedProfit.toFixed(0)}/contract)`;
                    alertClass = 'success';
                    
                    if (profitPercent >= 30) {
                        const breakevenFloor = avgPrice * 1.02;
                        const greenColor = document.body.classList.contains('dark-mode') ? 'var(--accent-green)' : '#28a745';
                        const redColor = document.body.classList.contains('dark-mode') ? 'var(--accent-red)' : '#dc3545';
                        message += `<br><br>üõ°Ô∏è <strong>PROFIT Floor ACTIVE:</strong> $${breakevenFloor.toFixed(2)} - NEVER Let <span style="color: ${greenColor}; font-weight: bold;">Green</span> TURN <span style="color: ${redColor}; font-weight: bold;">Red</span>`;
                    }
                }
                
                alertMessageEl.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            }

            function saveState() {
                const tradeData = {
                    avgPrice: avgPriceEl.value,
                    currentPrice: currentPriceEl.value,
                    delta: deltaEl.value,
                    atrValue: atrValueEl.value,
                    contracts: contractsEl.value,
                    tradeType: state.tradeType,
                    riskProfile: state.riskProfile,
                    storedStopLoss: state.storedStopLoss
                };
                localStorage.setItem(TRADE_STATE_KEY, JSON.stringify(tradeData));
            }

            function loadState() {
                const savedData = localStorage.getItem(TRADE_STATE_KEY);
                if (savedData) {
                    const tradeData = JSON.parse(savedData);
                    avgPriceEl.value = tradeData.avgPrice || '';
                    currentPriceEl.value = tradeData.currentPrice || '';
                    deltaEl.value = tradeData.delta || '';
                    atrValueEl.value = tradeData.atrValue || '';
                    contractsEl.value = tradeData.contracts || '1';
                    
                    state.tradeType = tradeData.tradeType || 'swing';
                    state.riskProfile = tradeData.riskProfile || 'balanced';
                    state.storedStopLoss = tradeData.storedStopLoss || null;

                    if (tradeTypeToggle.querySelector('.active')) tradeTypeToggle.querySelector('.active').classList.remove('active');
                    if (tradeTypeToggle.querySelector(`[data-type="${state.tradeType}"]`)) tradeTypeToggle.querySelector(`[data-type="${state.tradeType}"]`).classList.add('active');
                    
                    if(riskProfileToggle.querySelector('.active')) riskProfileToggle.querySelector('.active').classList.remove('active');
                    if(riskProfileToggle.querySelector(`[data-profile="${state.riskProfile}"]`)) riskProfileToggle.querySelector(`[data-profile="${state.riskProfile}"]`).classList.add('active');
                    
                    setAtrTimeframe();
                    runCalculations();
                }
            }
            
            function loadTheme() {
                const savedTheme = localStorage.getItem('tradingMatrixTheme');
                if (savedTheme === 'light') {
                    document.body.classList.remove('dark-mode');
                }
            }

            function clearAll() {
                avgPriceEl.value = '';
                currentPriceEl.value = '';
                deltaEl.value = '';
                atrValueEl.value = '';
                contractsEl.value = '1';
                
                handleToggle({ target: tradeTypeToggle.querySelector('[data-type="swing"]') }, 'tradeType', setAtrTimeframe);
                handleToggle({ target: riskProfileToggle.querySelector('[data-profile="balanced"]') }, 'riskProfile');
                
                state.storedStopLoss = null;
                state.achievedRLevels = { r1: false, r2: false, r3: false, r5: false };
                
                localStorage.removeItem(TRADE_STATE_KEY);
                
                alertMessageEl.innerHTML = '';
                updateDashboard(null);
                updateRRDisplay(null);
                
                avgPriceEl.focus();
            }
            
            [avgPriceEl, currentPriceEl, deltaEl, atrValueEl].forEach(el => {
                el.addEventListener('keydown', (e) => {
                    if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
                        (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                        (e.keyCode >= 35 && e.keyCode <= 40)) {
                        return;
                    }
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });
            });
            
            const checkDashboard = () => {
                if (window.innerWidth <= 600) {
                    desktopDashboard.style.display = 'none';
                    mobileDashboard.style.display = 'grid';
                } else {
                    desktopDashboard.style.display = 'grid';
                    mobileDashboard.style.display = 'none';
                }
            };

            window.addEventListener('resize', checkDashboard);
            
            loadTheme();
            loadState();
            checkDashboard();
            avgPriceEl.focus();
        });
    </script>
</body>
</html>
